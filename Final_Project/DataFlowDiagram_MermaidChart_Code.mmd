graph TD;
    %% Environment Setup
    A((Environment Setup)) --> B[Input Data and Set Variables]


    %% Input Data
    B --> C1[/Pollution Point Data/]
    B --> C2[/Parcel Shapefiles/]
    B --> C3[/Census Tract Shapefiles/]
    B --> C4[/Poverty Data Table/]
    B --> C5[/Demographics Data Table/]


    %% Parcel Data Processing
    C2 --> D2[Create Parcel Layer]
    D2 --> E2[Get Extent of Parcels Layer]
    C1 --> D1[Clip Pollution Point Data to Parcels Extent]
    E2 --> D1
    D1 --> E1[Spatial Join Pollution Points to Parcel Layer]
    E1 --> F1[Add Fields for Point Count and Distance]
    F1 --> G1[Calculate Points Count]
    G1 --> H1[Select Polygons with Zero Points Within Them]
    H1 --> I1[Calculate Nearest Distance for Zero Points]
    I1 --> J1[Update Main Output with Nearest Distance]
    J1 --> K1[Clean Parcel/Pollution Data]


    %% Poverty and Demographic Data Processing
    C4 --> L1[Convert Poverty Data Table to ArcGIS Table]
    L1 --> M1[Filter Poverty Data to Hennepin County]
    M1 --> N1[Clean Poverty Data]
    C5 --> L2[Convert Demographics Data Table to ArcGIS Table]
    L2 --> M2[Clean Demographics Data]
    C3 --> L3[Create Census Tracts Layer]
    N1 --> O1[Join Poverty Data to Census Tracts Layer]
    O1 --> L3
    M2 --> O2[Join Demographics Data to Census Tracts Layer]
    O2 --> L3
    L3 --> P1[/Updated Census Tracts Layer with Poverty and Demographics Data/]


    %% Joining Updated Census Tracts Layer to Parcel Data
    K1 --> Q1[Join Census Tract Layer to Parcel Layer]
    P1 --> Q1
    Q1 --> R1[Aggregate by PID]
    R1 --> S1[Clean Updated Parcel Data]


    %% Calculate Scores
    S1 --> T1[Calculate Pollution Scores]
    T1 --> T2[Add Pollution Score Field]
    T2 --> T3[Update Pollution Scores]
    S1 --> U1[Calculate Poverty Scores]
    U1 --> U2[Add Poverty Score Field]
    U2 --> U3[Update Poverty Scores]
    S1 --> V1[Calculate Demographics Scores]
    V1 --> V2[Add Demographics Score Field]
    V2 --> V3[Update Demographics Scores]
    W1[Calculate Composite Scores]
    T3 --> W1
    U3 --> W1
    V3 --> W1
    W1 --> W2[Add Composite Score Field]
    W2 --> W3[Update Composite Scores]
    W3 --> X1[Add Rank Field]
    X1 --> X2[Rank Parcels by Composite Score]
    X2 --> X3[/Visualize Results/]


    %% Sensitivity Analysis
    W3 --> Y1[Perform Sensitivity Analysis]
    Y1 --> Y2[Define Weight Schemes]
    Y2 --> Y3[Recalculate Composite Scores for Different Schemes]
    Y3 --> Y4[/Visualize Results of Different Schemes/]


    %% Add GEMS Lab Data
    W3 --> Z1[Add GEMS Lab Data]
    Z1 --> Z2[Perform Join Based on PID]
    Z2 --> Z3[Add GEMS Rank Field]
    Z3 --> Z4[/Visualize GEMS Output/]


    Z5((Analyze and Compare Results))
    X3 --> Z5
    Z4 --> Z5
    Y4 --> Z5


    %% Set colors for each shape type


    %% Circles (start/end or process with rounded edges)
    style A fill:#FFDDC1;
    style Z5 fill:#FFDDC1;


    %% Diamonds (rhombus shapes for decision or I/O)
    style C1 fill:#FF88C2;
    style C2 fill:#FF88C2;
    style C3 fill:#FF88C2;
    style C4 fill:#FF88C2;
    style C5 fill:#FF88C2;
    style P1 fill:#FF88C2;
    style X3 fill:#FF88C2;
    style Y4 fill:#FF88C2;
    style Z4 fill:#FF88C2;


    %% Rectangles (standard process steps)
    style B fill:#A9D0F5;
    style D2 fill:#A9D0F5;
    style E2 fill:#A9D0F5;
    style D1 fill:#A9D0F5;
    style E1 fill:#A9D0F5;
    style F1 fill:#A9D0F5;
    style G1 fill:#A9D0F5;
    style H1 fill:#A9D0F5;
    style I1 fill:#A9D0F5;
    style J1 fill:#A9D0F5;
    style K1 fill:#A9D0F5;
    style L1 fill:#A9D0F5;
    style M1 fill:#A9D0F5;
    style N1 fill:#A9D0F5;
    style L2 fill:#A9D0F5;
    style M2 fill:#A9D0F5;
    style O2 fill:#A9D0F5;
    style O1 fill:#A9D0F5;
    style L3 fill:#A9D0F5;
    style Q1 fill:#A9D0F5;
    style R1 fill:#A9D0F5;
    style S1 fill:#A9D0F5;
    style T1 fill:#A9D0F5;
    style T2 fill:#A9D0F5;
    style T3 fill:#A9D0F5;
    style U1 fill:#A9D0F5;
    style U2 fill:#A9D0F5;
    style U3 fill:#A9D0F5;
    style V1 fill:#A9D0F5;
    style V2 fill:#A9D0F5;
    style V3 fill:#A9D0F5;
    style W1 fill:#A9D0F5;
    style W2 fill:#A9D0F5;
    style W3 fill:#A9D0F5;
    style X1 fill:#A9D0F5;
    style X2 fill:#A9D0F5;
    style Y1 fill:#A9D0F5;
    style Y2 fill:#A9D0F5;
    style Y3 fill:#A9D0F5;
    style Z1 fill:#A9D0F5;
    style Z2 fill:#A9D0F5;
    style Z3 fill:#A9D0F5;





